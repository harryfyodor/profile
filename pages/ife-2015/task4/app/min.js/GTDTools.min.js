define(["selector","EventUtil"],function(e,a){function t(e,a,t){this.id=e,this.name=a,this.child=t}function n(e,a,t,n){this.id=e,this.name=a,this.child=t,this.father=n}function l(e,a,t,n,l,i){this.id=e,this.name=a,this.father=t,this.date=n,this.content=l,this.finished=i}function i(){var a='[{"id":0,"name":"大任务","child":[0,1]}]',t='[{"id":0,"name":"中任务0","child":[0],"father":0},{"id":1,"name":"中任务1","child":[1,2],"father":0}]',n='[{"id":0,"name":"小任务0","date":"2016-02-17","content":"完成这个小任务0","father":0,"finished":"false"},{"id":1,"name":"小任务1","date":"2016-02-17","content":"完成这个小任务1","father":1,"finished":"false"},{"id":2,"name":"小任务2","date":"2016-02-16","content":"完成这个小任务2","father":1,"finished":"false"}]';location.href="#cata";var l="#cata";localStorage.cata||(localStorage.cata=a,localStorage.docu=t,localStorage.task=n),T=JSON.parse(localStorage.cata),B=JSON.parse(localStorage.docu),H=JSON.parse(localStorage.task),console.log(T),console.log(B),console.log(H),window.onhashchange=function(){var a=location.hash,t=e("."+l.substr(1)),n=e("."+a.substr(1));console.log(t),console.log(n),t&&n&&("cata"==t.className&&"docu"==n.className||"docu"==t.className&&"task"==n.className?(t.style.display="none",n.style.display="block"):("docu"==t.className&&"cata"==n.className||"task"==t.className&&"docu"==n.className)&&(t.style.display="none",n.style.display="block"),l=a)}}function s(){var a=e(".cata ul"),t="",n="";n='<li class="c1">默认分类</li>';for(var l=0,i=T.length;i>l;l++){for(var s=0,r=B.length;r>s;s++)B[s].father==T[l].id&&(t=t+'<li class="c2" id="b'+B[s].id+'">'+B[s].name+"（"+B[s].child.length+'）<a class="delete-c2">删</a>');t="<ul>"+t+"</ul>",n=n+'<li class="c1" id="a'+T[l].id+'">'+T[l].name+'<a class="delete-c1">删</a>'+t+"</li>",t=""}a.innerHTML=n,c(),d(),o(),g(),w&&v()}function d(){var l=e(".new-build-docu"),i=e(".new-build").getElementsByTagName("button")[0],d=e(".new-build").getElementsByTagName("button")[1],o=e(".new-build").getElementsByTagName("input")[0],c=e(".new-build").getElementsByTagName("input")[1],r=e(".new-build"),y=e(".new-build-background");a.addHandler(l,"click",function(){y.style.display="block",r.style.display="block"}),a.addHandler(d,"click",function(){y.style.display="none",r.style.display="none"}),a.addHandler(i,"click",function(){var e=o.value,a=c.value,l=0;if(""==a||""==e)alert("请填写名字或内容。");else{for(var i=0,d=T.length;d>i;i++)if(T[i].name==a){var u=B[B.length-1].id+1,f=e,g=T[i].id,h=[],p=new n(u,f,h,g);B.push(p),l=1}if(0==l){var m=T[T.length-1].id+1,v=a,k=[],u=B[B.length-1].id+1,f=e,g=m,h=[];k.push(u);var N=new t(m,v,k),p=new n(u,f,h,g);T.push(N),B.push(p)}E(),o.value="",c.value="",y.style.display="none",r.style.display="none",s()}})}function o(){var t=e(".task-header-date input"),n=e(".task-header-date").getElementsByTagName("p")[0],i=e(".task-header-name").getElementsByTagName("p")[0],s=e(".task-header-name").getElementsByTagName("label")[0],d=e(".task-header-name").getElementsByTagName("input")[0],o=e(".task-content").getElementsByTagName("p")[0],c=e(".task-content").getElementsByTagName("textarea")[0],y=e("#finished"),u=e("#edit"),g=e("#edit-finished"),h=e("#edit-new-build"),p=e("#edit-cancel"),m=e(".new-build-task");a.addHandler(m,"click",function(){e(".c2-active")?(t.style.display="inline-block",s.style.display="inline-block",d.style.display="inline-block",c.style.display="block",h.style.display="block",p.style.display="block",n.style.display="none",i.style.display="none",o.style.display="none",y.style.display="none",u.style.display="none",g.style.display="none",t.value="按照yyyy-mm-dd输入日期",d.value="",c.value=""):alert("请选择一个文件。"),w&&(location.href="#task")}),a.addHandler(t,"focus",function(){var e,a,n=new Date;e=parseInt(n.getMonth())+1<10?"0"+(parseInt(n.getMonth())+1):parseInt(n.getMonth())+1,a=parseInt(n.getDate())<10?"0"+parseInt(n.getDate()):parseInt(n.getDate()),t.value=n.getFullYear()+"-"+e+"-"+a}),a.addHandler(p,"click",function(){e(".d2-active")?f(e(".d2-active").id):b(),w&&(location.href="#docu")}),a.addHandler(h,"click",function(){var a=t.value,n=d.value,i=c.value;if(k(a,n)&&e(".c2-active")){var s=a,o=n,y=i,u=H[H.length-1].id+1,g="false",h=e(".c2-active").id[1],p=new l(u,o,h,s,y,g);H.push(p),console.log(p),B[h].child.push(u),t.value="",d.value="",c.value="",E(),r(),f(u)}})}function c(){var a=e("*c2");if(a)for(var t=0,n=a.length;n>t;t++)a[t].onclick=function(t){return function(){for(var n=0,l=a.length;l>n;n++)a[n].className="c2";a[t].className=a[t].className+" c2-active",r(),e(".d2-active")||b(),w&&(location.href="#docu")}}(t)}function r(){var a=(e("c2"),e(".docu").getElementsByTagName("ul")[1]),t="",n="",l="",i=[],s=[];if(e(".c2-active"))for(var d=0,o=H.length;o>d;d++)e(".c2-active").id[1]==H[d].father&&i.push(H[d]);if(console.log(i),i)for(var c=0,o=i.length;o>c;c++)s.push(i[c].date);s=N(s),s.sort(),n="";for(var r=0,f=s.length;f>r;r++){t="";for(var g=0,h=i.length;h>g;g++)l="（未完成）",i[g].date==s[r]&&("true"===i[g].finished&&(l="（完成）"),t=t+'<li class="d2" id="'+i[g].id+'">'+i[g].name+l+'<a class="delete-d2">删</a></li>');t="<ul>"+t+"</ul>",n=n+'<li class="d1"><span>'+s[r]+"</span>"+t+"</li>"}a.innerHTML=n,y(),u()}function y(){if(e(".d2"))var a=e("*d2");var t=e(".docu-header").getElementsByTagName("li");a&&(t[0].onclick=function(){for(var e=0,t=a.length;t>e;e++)a[e].style.display="block"},t[1].onclick=function(){for(var e=0,t=a.length;t>e;e++)for(var n=0;n<H.length;n++)a[e].id==H[n].id&&("true"==H[n].finished?a[e].style.display="none":a[e].style.display="block")},t[2].onclick=function(){for(var e=0,t=a.length;t>e;e++)for(var n=0;n<H.length;n++)a[e].id==H[n].id&&("true"==H[n].finished?a[e].style.display="block":a[e].style.display="none")})}function u(){var a=e("*d2");if(a)for(var t=0,n=a.length;n>t;t++)a[t].onclick=function(e){return function(){var t=0;for(a.length;n>t;t++)a[t].className="d2";a[e].className=a[e].className+" d2-active",f(a[e].id),g(),w&&(location.href="#task")}}(t)}function f(t){var n=e(".task-header-date input"),l=e(".task-header-date").getElementsByTagName("p")[0],i=e(".task-header-name").getElementsByTagName("p")[0],d=e(".task-header-name").getElementsByTagName("label")[0],o=e(".task-header-name").getElementsByTagName("input")[0],c=e(".task-content").getElementsByTagName("p")[0],r=e(".task-content").getElementsByTagName("textarea")[0],y=e("#finished"),u=e("#edit"),g=e("#edit-finished"),h=e("#edit-new-build"),p=e("#edit-cancel");n.style.display="none",d.style.display="none",o.style.display="none",r.style.display="none",g.style.display="none",h.style.display="none",p.style.display="none",l.style.display="inline",i.style.display="block",c.style.display="block",y.style.display="block",u.style.display="block";for(var m,v=0;v<H.length;v++)H[v].id==t&&(m=v);t=m,l.innerHTML=H[t].date,i.innerHTML=H[t].name,c.innerHTML=H[t].content,a.addHandler(y,"click",function(){"true"!=H[t].finished&&(H[t].finished="true",E(),s(),document.getElementById(t).innerHTML.replace(/未/,""))}),a.addHandler(u,"click",function(){e(".d2-active")&&(r.style.display="block",l.style.display="inline",i.style.display="block",g.style.display="block",n.style.display="none",d.style.display="none",o.style.display="none",h.style.display="none",p.style.display="none",y.style.display="none",u.style.display="none",c.style.display="none",r.value=H[e(".d2-active").id].content)}),a.addHandler(g,"click",function(){e(".d2-active")&&(H[e(".d2-active").id].content=r.value),E(),f(e(".d2-active").id)})}function g(){for(var e=document.getElementsByClassName("delete-c1"),t=document.getElementsByClassName("delete-c2"),n=document.getElementsByClassName("delete-d2"),l=0,i=e.length;i>l;l++)e[l].onclick=function(t){return function(n){a.stopPropagation(a.getEvent(n)),confirm("你要删除这个分类吗？")&&h(e[t].parentNode.id[1]),s()}}(l);for(var d=0,o=t.length;o>d;d++)t[d].onclick=function(e){return function(n){if(a.stopPropagation(a.getEvent(n)),confirm("你要删除这个文件吗？")){document.getElementsByClassName("c2");p(t[e].parentNode.id[1]),b(),s()}}}(d);for(var c=0,y=n.length;y>c;c++)n[c].onclick=function(e){return function(t){if(a.stopPropagation(a.getEvent(t)),confirm("你要删除这个任务吗？")){document.getElementsByClassName("d2");console.log(n[e].parentNode.id),m(n[e].parentNode.id),r(),b()}}}(c)}function h(e){for(var a,t=0,n=T.length;n>t;t++)e==T[t].id&&(a=t);for(var l=B.length-1;l>=0;l--)H[l]&&B[l].father==e&&B.splice(l,1);T.splice(a,1),E()}function p(e){for(var a,t=0,n=B.length;n>t;t++)e==B[t].id&&(a=t);B[a]&&T[B[a].father].child.splice(T[B[a].father].child.indexOf(e),1),B.splice(a,1);for(var l=H.length-1;l>=0;l--)H[l]&&H[l].father==e&&H.splice(l,1);E()}function m(e){for(var a,t=0,n=H.length;n>t;t++)e==H[t].id&&(a=t);B[H[a].father].child.splice(B[H[a].father].child.indexOf(e),1),H.splice(a,1),E()}function v(){var t=e(".task-btn-group button"),n=e(".return-docu button");a.addHandler(n,"click",function(){location.href="#cata"}),a.addHandler(t,"click",function(){location.href="#docu"})}function k(e,a){var t=new Date,n=t.getFullYear(),l=t.getMonth(),i=t.getDate();if(!e||!a)return!1;if(/(\d{4})-(\d{2})-(\d{2})/.test(e))if(RegExp.$2>12||RegExp.$3>31)alert("请输入一个正确的日期。");else if(RegExp.$1<n||RegExp.$2<l&&RegExp.$1==n||RegExp.$1==n&&RegExp.$2==l&&RegExp.$3<i)alert("请输入一个还没过去的时间。");else{if(/\S+/.test(a)&&""!=a)return!0;alert("名字不能为空。")}else alert("请按照正确格式 “yyyy-mm-dd” 输入 。");return!1}function N(e){for(var a=[],t=0,n=e.length;n>t;t++)""!==e[t]&&a.indexOf(e[t])<0&&a.push(e[t]);return a}function b(){e(".task-header-date input").style.display="none",e(".task-header-name").getElementsByTagName("label")[0].style.display="none",e(".task-header-name").getElementsByTagName("input")[0].style.display="none",e(".task-content").getElementsByTagName("textarea")[0].style.display="none",e("#finished").style.display="none",e("#edit").style.display="none",e("#edit-finished").style.display="none",e("#edit-new-build").style.display="none",e("#edit-cancel").style.display="none",e(".task-header-name").getElementsByTagName("p")[0].style.display="block",e(".task-header-date").getElementsByTagName("p")[0].style.display="inline-block",e(".task-content").getElementsByTagName("p")[0].style.display="block",e(".task-header-name").getElementsByTagName("p")[0].innerHTML="GTDTools",e(".task-header-date").getElementsByTagName("p")[0].innerHTML="2016-02-27",e(".task-content").getElementsByTagName("p")[0].innerHTML="欢饮使用GTDTool 2.0"}function E(){localStorage.cata=JSON.stringify(T),localStorage.docu=JSON.stringify(B),localStorage.task=JSON.stringify(H)}var T,B,H,w=navigator.userAgent.match(/(iPhone|iPod|Android|ios|iPad)/i);return{show:s,init:i}});